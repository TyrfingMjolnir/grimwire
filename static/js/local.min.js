"undefined"==typeof this.local&&(this.local={}),function(){function e(e){return e&&"function"==typeof e.then}function t(e){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,e&&this.fulfill(e)}function n(t,n,r){if(null===r)t.isRejected()?n.reject(t.value):n.fulfill(t.value);else{var i;try{i=r(t.value)}catch(o){return(local.logAllExceptions||o instanceof Error)&&(console.error?console.error(o,o.stack):console.log("Promise exception thrown",o,o.stack)),n.reject(o)}e(i)?s(i).chain(n):n.fulfill(i)}}function r(e,t){Array.isArray(e)||(e=[e]);var n=s(),r=e.length,i=0;if(0===r)return n.fulfill([]),n;var o=[];o.length=r;for(var a=[],l=function(e,s,l){o[s]=e,l&&a.push(s),++i==r&&(t?t(o,a)?n.fulfill(o):n.reject(o):n.fulfill(o))},c=0;r>c;c++)s(e[c]).succeed(l,c,!1).fail(l,c,!0);return n}function i(e){return r(e,function(e,t){return 0===t.length})}function o(e){return r(e,function(e,t){return t.length<e.length})}function s(n){if(arguments.length>1)return r(Array.prototype.slice.call(arguments));if(n instanceof t)return n;if(e(n)){var i=s();return n.then(function(e){i.fulfill(e)},function(e){i.reject(e)}),i}return new t(n)}t.prototype.isUnfulfilled=function(){return!this.__hasValue},t.prototype.isRejected=function(){return this.__hasFailed},t.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},t.prototype.then=function(e,t){e=e&&"function"==typeof e?e:null,t=t&&"function"==typeof t?t:null;var r=s();if(this.isUnfulfilled())this.succeedCBs.push({p:r,fn:e}),this.failCBs.push({p:r,fn:t});else{var i=this;local.util.nextTick(function(){i.isFulfilled()?n(i,r,e):n(i,r,t)})}return r},t.prototype.succeed=function(e){if(this.isRejected())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(function(n){return e.apply(null,[n].concat(t))})},t.prototype.fail=function(e){if(this.isFulfilled())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(null,function(n){return e.apply(null,[n].concat(t))})},t.prototype.always=function(e){return this.then(e,e)},t.prototype.fulfill=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0;for(var t=0;t<this.succeedCBs.length;t++){var r=this.succeedCBs[t];n(this,r.p,r.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.reject=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0,this.__hasFailed=!0;for(var t=0;t<this.failCBs.length;t++){var r=this.failCBs[t];n(this,r.p,r.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.cancel=function(){var e;for(e=0;e<this.succeedCBs.length;e++)this.succeedCBs[e].p.cancel();for(e=0;e<this.failCBs.length;e++)this.failCBs[e].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},t.prototype.chain=function(e){return this.then(function(t){return s(e).fulfill(t),t},function(t){return s(e).reject(t),t}),e},t.prototype.cb=function(e,t){e?this.reject(e):this.fulfill("undefined"==typeof t?null:t)},local.Promise=t,local.promise=s,local.promise.bundle=r,local.promise.all=i,local.promise.any=o}(),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.util&&(this.local.util={}),function(){function e(){Object.defineProperty(this,"_events",{value:{},configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_suspensions",{value:0,configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_history",{value:[],configurable:!1,enumerable:!1,writable:!0})}function t(e,t){for(;e;){if(t(e))return e;e=e.parentNode}return null}function n(){for(var e,t=Array.prototype.slice.call(arguments),r={};t.length;)if(e=t.shift())for(var i in e)"undefined"!=typeof e[i]&&null!==e[i]&&(r[i]="object"!=typeof e[i]||Array.isArray(e[i])?e[i]:n(r[i],e[i]));return r}function r(e,t){var n=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:t});e.dispatchEvent(n)}function i(e){var n=t.thatisFormRelated(e);if(n){for(var r=0;r<n.form.length;r++)n.form[r].setAttribute("submitter",null);n.setAttribute("submitter","1")}}function o(e,r){var i={form:{},fieldset:{},elem:{}},a=null,l=null;if("FIELDSET"===e.tagName?a=e:"FORM"!==e.tagName&&(a=t.byTag(e,"FIELDSET")),"FORM"===e.tagName)l=e;else{var c=e.getAttribute("form")||(a?a.getAttribute("form"):null);c&&(l=r.querySelector("#"+c)),l||(l=t.byTag(e,"FORM"))}var u=s(e,l);l&&(i.form=o.fromForm(l,e)),a&&(i.fieldset=o.fromFormElement(a)),"A"===e.tagName?i.elem=o.fromAnchor(e):-1===["FORM","FIELDSET"].indexOf(e.tagName)&&(i.elem=o.fromFormElement(e));var h=n(i.form,i.fieldset,i.elem),f={};return f[/GET/i.test(h.method)?"query":"body"]=u,n(h,f)}function s(e,n,r){r||(r={});var i={};r.nofiles||(i.__fileReads=[]);for(var o=0;o<n.length;o++){var s=n[o];if(s.name&&(!e||t.byElement(s,e))){var l="1"==s.getAttribute("submitter");if("BUTTON"===s.tagName)l&&(i[s.name]=s.value);else if("INPUT"===s.tagName)switch(s.type.toLowerCase()){case"button":case"submit":l&&(i[s.name]=s.value);break;case"checkbox":s.checked&&(i[s.name]=(i[s.name]||[]).concat(s.value));break;case"radio":null!==s.getAttribute("checked")&&(i[s.name]=s.value);break;case"file":if(r.nofiles)break;if(s.multiple){for(var c,o=0;c=s.files[o];o++)a(i,s,s.files[o],o);i[s.name]=[],i[s.name].length=o}else a(i,s,s.files[0]);break;default:i[s.name]=s.value}else i[s.name]=s.value}}return i}function a(e,t,n,r){if(n){var i=new FileReader;i.onloadend=l(e,t,n,r),i.readAsDataURL(n)}}function l(e,t,n,r){var i=local.promise();return e.__fileReads.push(i),function(e){var o={content:e.target.result||null,name:n.name,formattr:t.name,size:n.size,type:n.type,lastModifiedDate:n.lastModifiedDate};"undefined"!=typeof r&&(o.formindex=r),i.fulfill(o)}}function c(e){var t=e.body?e.body.__fileReads:e.query?e.query.__fileReads:[];return local.promise.bundle(t).then(function(t){return e.body&&delete e.body.__fileReads,e.query&&delete e.query.__fileReads,t.forEach(function(t){"undefined"!=typeof t.formindex?e.body[t.formattr][t.formindex]=t:e.body[t.formattr]=t}),e})}if(e.prototype.suspendEvents=function(){this._suspensions++},e.prototype.resumeEvents=function(){this._suspensions--,this._suspensions<=0&&this.playbackHistory()},e.prototype.isSuspended=function(){return this._suspensions>0},e.prototype.playbackHistory=function(){for(var e;!this.isSuspended()&&(e=this._history.shift());)this.emit.apply(this,e)},e.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments);if(this.isSuspended())return this._history.push(t),void 0;var n=this._events[e];if(!n)return!1;t=t.slice(1);for(var r=0,i=n.length;i>r;r++)n[r].apply(this,t);return!0},e.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this.emit("newListener",e,t),this._events[e]?this._events[e].push(t):this._events[e]=[t],this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){var n=this;return n.on(e,function r(){n.removeListener(e,r),t.apply(this,arguments)}),this},e.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var n=this._events[e],r=n.indexOf(t);return 0>r?this:(n.splice(r,1),0===n.length&&delete this._events[e],this)},e.prototype.removeAllListeners=function(e){return e?this._events[e]=null:this._events={},this._history[e]&&(this._history[e]=null),this},e.prototype.listeners=function(e){return this._events[e]},local.util.EventEmitter=e,local.util.mixinEventEmitter=function(t){e.call(t);for(var n in e.prototype)t[n]=e.prototype[n]},"undefined"==typeof CustomEvent&&(CustomEvent=function(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}),local.util.isAppClosing=!1,"undefined"!=typeof window&&window.addEventListener("beforeunload",function(){local.util.isAppClosing=!0}),t.byTag=function(e,n){return t(e,function(e){return e.tagName==n})},t.byTagOrAlias=function(e,n){return t(e,function(e){return e.tagName==n||e.dataset&&e.dataset.localAlias&&e.dataset.localAlias.toUpperCase()==n})},t.byClass=function(e,n){return t(e,function(e){return e.classList&&e.classList.contains(n)})},t.byElement=function(e,n){return t(e,function(e){return e===n})},t.thatisFormRelated=function(e){return t(e,function(e){return!!e.form})},o.fromAnchor=function(e){if(e=t.byTagOrAlias(e,"A"),!e||!e.attributes.href||"#"==e.attributes.href.value.charAt(0))return null;var n={method:e.getAttribute("method"),url:e.attributes.href.value,target:e.getAttribute("target"),headers:{accept:e.getAttribute("type")}};return n},o.fromFormElement=function(e){var t={method:e.getAttribute("formmethod"),url:e.getAttribute("formaction"),target:e.getAttribute("formtarget"),headers:{"content-type":e.getAttribute("formenctype"),accept:e.getAttribute("formaccept")}};return t},o.fromForm=function(e,t){if(t&&!t.form)for(var r=0;r<e.length;r++){var i=e[r];if("1"==i.getAttribute("submitter")){t=i,i.setAttribute("submitter","0");break}}var o={submitter:{},form:{}};t&&(o.submitter={method:t.getAttribute("formmethod"),url:t.getAttribute("formaction"),target:t.getAttribute("formtarget"),headers:{"content-type":t.getAttribute("formenctype"),accept:t.getAttribute("formaccept")}}),o.form={method:e.getAttribute("method"),url:e.getAttribute("action"),target:e.getAttribute("target"),headers:{"content-type":e.getAttribute("enctype")||e.enctype,accept:e.getAttribute("accept")}},e.acceptCharset&&(o.form.headers.accept=e.acceptCharset);var s=n(o.form,o.submitter);return s},local.util.findParentNode=t,local.util.trackFormSubmitter=i,local.util.dispatchRequestEvent=r,local.util.extractRequest=o,local.util.extractRequestPayload=s,local.util.finishPayloadFileReads=c,local.util.deepClone=function(e){return JSON.parse(JSON.stringify(e))},"undefined"==typeof window||window.ActiveXObject||!window.postMessage)local.util.nextTick=function(e){setTimeout(e,0)};else{var u=0,h={};local.util.nextTick=function(e){if("function"!=typeof e)throw"Invalid function provided to nextTick";window.postMessage("nextTick"+u,"*"),h["nextTick"+u]=e,u++},window.addEventListener("message",function(e){var t=h[e.data];delete h[e.data],t()},!0)}}(),"undefined"==typeof this.local&&(this.local={}),function(){function e(e,t){var r=t.filter(function(t){return n(e,t)}).sort(function(e,t){return e.q>t.q?-1:1});return r[0]?r[0].q:0}function t(e,t){return"*"===e||e===t}function n(e,n){var r=d(e);if(n.params){var i=Object.keys(n.params);if(i.some(function(e){return!t(n.params[e],r.params[e])}))return null}return t(n.type,r.type)&&t(n.subtype,r.subtype)?n:void 0}function r(e,t){if(!t||"object"!=typeof t||!e)return t;var n=a(e,"serializer");return n?n(t):t}function i(e,t){if(!t||"string"!=typeof t||!e)return t;var n=a(e,"deserializer");if(!n)return t;try{return n(t)}catch(r){return console.warn("Failed to deserialize content",e,t),t}}function o(e,t,n){M[e]={serializer:t,deserializer:n}}function s(e){var t=e.split(";"),n=t[0];if(t=n.split("/"),t[1]){var r=t[1].split("+");return r[1]?[n,t[0]+"/"+r[1],t[0]]:[n,t[0]]}return[n]}function a(e,t){for(var n=s(e),r=0;r<n.length;r++)if(n[r]in M)return M[n[r]][t];return null}function l(e){var t=e.indexOf(":");return[e.slice(0,t).trim(),e.slice(t+1).trim()]}function c(e,t){if(!t||"object"!=typeof t||!e)return t;var n=f(e,"serializer");if(!n)return t;try{return n(t)}catch(r){return console.warn("Failed to serialize header",e,t),t}}function u(e,t){if(!t||"string"!=typeof t||!e)return t;var n=f(e,"deserializer");if(!n)return t;try{return n(t)}catch(r){return console.warn("Failed to deserialize header",e,t),t}}function h(e,t,n){G[e.toLowerCase()]={serializer:t,deserializer:n}}function f(e,t){var n=G[e.toLowerCase()];return n?n[t]:null}function d(e){var t=e.match(/\s*(\S+)\/([^;\s]+)\s*(?:;(.*))?/);if(!t)return null;var n=t[1],r=t[2],i=""+n+"/"+r,o={},s=1;return t[3]&&(o=t[3].split(";").map(function(e){return e.trim().split("=")}).reduce(function(e,t){return e[t[0]]=t[1],e},o),null!==o.q&&(s=parseFloat(o.q),delete o.q)),{type:n,subtype:r,params:o,q:s,full:i}}function p(e){local.util.EventEmitter.call(this),e||(e={}),"string"==typeof e&&(e={url:e});var t=e.headers||{};y(e,t),this.method=e.method?e.method.toUpperCase():"GET",this.url=e.url||null,this.path=e.path||null,this.host=e.host||null,this.query=e.query||{},this.headers=g(t),e.body&&!this.headers["content-type"]&&(this.headers["content-type"]="string"==typeof e.body?"text/plain":"application/json"),this.headers.accept||(this.headers.accept="*/*"),Object.defineProperty(this,"parsedHeaders",{value:{},configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"body",{value:e.body||"",configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"stream",{value:e.stream||!1,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"binary",{value:e.binary||!1,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"isConnOpen",{value:!0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"body_",{value:local.promise(),configurable:!0,enumerable:!1,writable:!1}),function(e){e.on("data",function(t){e.body+=t}),e.on("end",function(){e.headers["content-type"]&&(e.body=local.contentTypes.deserialize(e.headers["content-type"],e.body)),e.body_.fulfill(e.body)})}(this)}function g(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n.toLowerCase()]=e[n]);return t}function y(e,t){for(var n in e){var r=n.charAt(0);if(e.hasOwnProperty(n)&&r===r.toUpperCase()){var i=n.replace(X,"-");t[i]=e[n],delete e[n]}}}function m(){var e=this;local.util.EventEmitter.call(this),this.status=0,this.reason=null,this.headers={},this.body="",Object.defineProperty(this,"parsedHeaders",{value:{},configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"isConnOpen",{value:!0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"latency",{value:void 0,configurable:!0,enumerable:!1,writable:!0}),this.on("headers",function(){for(var t in e.headers){var n=v(t);"undefined"==typeof e[n]&&Object.defineProperty(e,n,{value:e.headers[t],configurable:!0,enumerable:!1,writable:!0});var r=b(n);"undefined"==typeof e[r]&&Object.defineProperty(e,r,{value:e.headers[t],configurable:!0,enumerable:!1,writable:!0})}}),Object.defineProperty(this,"body_",{value:local.promise(),configurable:!0,enumerable:!1,writable:!1}),this.on("data",function(t){t instanceof ArrayBuffer?e.body=t:e.body+=t}),this.on("end",function(){e.headers["content-type"]&&(e.body=local.contentTypes.deserialize(e.headers["content-type"],e.body)),e.body_.fulfill(e.body)})}function v(e){return e.replace($,function(e){return e.toUpperCase()})}function b(e){return e.replace(Y,"_")}function w(e){if(this.config={domain:null,log:!1},e)for(var t in e)this.config[t]=e[t]}function E(e){w.call(this,e),this.sidCounter=1,this.incomingStreams={},this.incomingStreamsBuffer={},this.outgoingStreams={},this.msgBuffer=[],this.isReorderingMessages=!1}function C(e){return""===e?!1:(e=e.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,""),/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(e))}function S(e){return e?isNaN(e.sid)?!1:!0:!1}function T(e){if(!e||!e.src)throw new Error("WorkerBridgeServer requires config with `src` attribute.");local.BridgeServer.call(this,e),this.isActive=!1,this.hasHostPrivileges=!0,e.serverFn&&(this.configServerFn=e.serverFn,delete this.config.serverFn),this.config.domain||(this.config.domain="<"+this.config.src.slice(0,40)+">"),this.config.environmentHost=window.location.host,this.config.shared?(this.worker=new SharedWorker(e.src,e.namespace),this.worker.port.start()):this.worker=new Worker(e.src),this.getPort().addEventListener("message",function(e){var t=e.data;if(!t)return console.error("Invalid message from worker: Payload missing",this,e);switch(this.config.log&&this.debugLog("received from worker",t),t.op){case"ready":this.onWorkerReady(t.body);break;case"log":this.onWorkerLog(t.body);break;case"terminate":this.terminate();break;default:this.onChannelMessage(t)}}.bind(this))}function R(e,t){if(e&&Array.isArray(e))for(var n=0,r=e.length;r>n;n++)R(e[n],t);else Q[e]=t}function A(e){delete Q[e]}function O(e){return Q[e]}function x(e){var t=/^([^.^:]*):/.exec(e);return t?t[1]:0===e.indexOf("//")?"http":0===e.indexOf("||")?"nav":"httpl"}function L(e,t){local.util.EventEmitter.call(this),this.request=e,this.response=null,this.response_=null,this.lastEventId=-1,this.isConnOpen=!0,this.connect(t)}function _(e){this.emit("message",e),this.emit("error",e)}function q(e){e=local.contentTypes.deserialize("text/event-stream",e);var t=parseInt(e.id,10);"undefined"!=typeof t&&t>this.lastEventId&&(this.lastEventId=t),this.emit("message",e),this.emit(e.event,e)}function D(){this.streams=[]}function P(e){this.query=e,this.resolveState=P.UNRESOLVED,this.error=null,this.queryIsAbsolute="string"==typeof e&&local.isAbsUri(e),this.queryIsAbsolute?(this.url=e,this.urld=local.parseUri(this.url)):(this.url=null,this.urld=null)}function k(e,t){this.context=e||null,this.parentAgent=t||null,this.links=null,this.requestDefaults=null}function N(e,t){for(var n in t)"headers"==n||e[n]||(e[n]="object"==typeof t[n]?local.util.deepClone(t[n]):t[n]);t.headers&&(e.headers||(e.headers={}),N(e.headers,t.headers))}function I(e){return function(t){var n=t||{};return n.method=e,this.dispatch(n)}}function H(e){return function(t,n){var r=n||{};return r.method=e,r.body=t,this.dispatch(r)}}local.LINK_NOT_FOUND=1,local.queryLinks=function(e,t){return e?(e.parsedHeaders&&(e=e.parsedHeaders.link),Array.isArray(e)?e.filter(function(e){return local.queryLink(e,t)}):[]):[]},local.queryLink=function(e,t){for(var n in t)if("rel"==n)for(var r=t.rel.split(/\s+/),i=0;i<r.length;i++){var o=!0;if("!"==r[i].charAt(0)&&(r[i]=r[i].slice(1),o=!1),RegExp("(\\s|^)(.*//)?"+r[i]+"(\\s|$)","i").test(e.rel)!==o)return!1}else if("undefined"==typeof e[n]){if(RegExp("\\{[^\\}]*"+n+"[^\\{]*\\}","i").test(e.href)===!0)continue;if(t[n])return!1}else if(t[n]&&t[n].indexOf&&0===t[n].indexOf("!")){if(e[n]==t[n].slice(1))return!1}else if(e[n]!=t[n])return!1;return!0},local.preferredTypes=function(t,n){return"object"==typeof t&&(t=t.headers.accept),t=local.httpHeaders.deserialize("accept",t||""),n?(Array.isArray(n)||(n=[n]),n.map(function(n){return[n,e(n,t)]}).filter(function(e){return e[1]>0}).sort(function(e,t){return e[1]===t[1]?0:e[1]>t[1]?-1:1}).map(function(e){return e[0]})):t.map(function(e){return e.full})},local.preferredType=function(e,t){return local.preferredTypes(e,t)[0]},local.joinUri=function(){var e=Array.prototype.map.call(arguments,function(e,t){e=""+e;var n=0,r=e.length;return"/"==e?"":(0!==t&&"/"===e.charAt(0)&&(n+=1),"/"===e.charAt(r-1)&&(r-=1),e.substring(n,r))});return e.join("/")};var j=/^((http(s|l)?:)?\/\/)|((nav:)?\|\|)/;local.isAbsUri=function(e){if(j.test(e))return!0;var t=local.parseUri(e);return!!local.getServer(t.authority)||!!local.parsePeerDomain(t.authority)};var U=/^(nav:)?\|?\|/i;local.isNavSchemeUri=function(e){return U.test(e)},local.joinRelPath=function(e,t){"string"==typeof e&&(e=local.parseUri(e));var n=e.protocol?e.protocol+"://":!1;if(n||(n=0===e.source.indexOf("//")?"//":0===e.source.indexOf("||")?"||":"httpl://"),"/"==t.charAt(0))return n+e.authority+t;for(var r=e.path,i=r.split("/"),o=t.split("/"),s=0,a=o.length;a>s;s++)"."!=o[s]&&(".."==o[s]?i.pop():i.push(o[s]));return local.joinUri(n+e.authority,i.join("/"))},local.parseUri=function(e){if("object"==typeof e&&(e.url?e=e.url:(e.host||e.path)&&(e=local.joinUri(req.host,req.path))),"data:"==e.slice(0,5))return{protocol:"data",source:e};if(-1!==e.indexOf("!")){var t=e.indexOf("//"),n=e.indexOf("/",t+2),r=e.slice(-1!==t?t+2:0,-1!==n?n:e.length),i=local.parsePeerDomain(r);if(i){var o={};return-1!==n&&e.slice(n)&&(o=local.parseUri(e.slice(n))),o.protocol="httpl",o.host=o.authority=r,o.port=o.password=o.user=o.userInfo="",o.source=e,o}}for(var s=local.parseUri.options,a=s.parser[s.strictMode?"strict":"loose"].exec(e),l={},c=14;c--;)l[s.key[c]]=a[c]||"";return l[s.q.name]={},l[s.key[12]].replace(s.q.parser,function(e,t,n){t&&(l[s.q.name][t]=n)}),l},local.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@\/]*)(?::([^:@\/]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@\/]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@\/]*)(?::([^:@\/]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},local.parseNavUri=function(e){if(!e)return[];var t=e.indexOf("||");-1!==t&&(e=e.slice(t+2));for(var n=e.split("|"),r=1;r<n.length;r++){for(var i={},o=n[r].split(","),s=0;s<o.length;s++){var a=o[s].split("=");0===s?(i.rel=a[0].replace(/\+/g," "),a[1]&&(i.id=a[1])):i[a[0]]=decodeURIComponent(a[1]).replace(/\+/g," ")}n[r]=i}return n[0]||n.shift(),n};var F=/^(.+)@([^!]+)!([^!\/]+)(?:!([\d]+))?$/i;local.parsePeerDomain=function(e){var t=F.exec(e);return t?{domain:e,user:t[1],relay:t[2],provider:t[2],app:t[3],stream:t[4]||0,sid:t[4]||0}:null},local.makePeerDomain=function(e,t,n,r){return e+"@"+t+"!"+n+(r?"!"+r:"")},local.viaToUri=function(e){var t="";if(e&&e.length){var n=0,r=function(e){for(var t=0;n>t;t++)e=encodeURIComponent(e);return n++,e};t=e.map(function(e){return r((e.proto.name||"http").toLowerCase()+"://"+e.hostname)}).join("/")}return t},local.pipe=function(e,t,n,r){return n=n||function(e){return e},r=r||function(e){return e},local.promise(t).succeed(function(t){return e.status||e.writeHead(t.status,t.reason,n(t.headers)),null!==t.body&&"undefined"!=typeof t.body&&e.write(r(t.body)),t.on&&t.isConnOpen?(t.on("data",function(t){e.write(r(t))}),t.on("end",function(){e.end()})):e.end(),e}).fail(function(t){var n=t.headers["content-type"]||"text/plain",r=n&&t.body?t.body:"";throw e.writeHead(502,"bad gateway",{"content-type":n}),e.end(r),t})},local.patchXHR=function(){function e(){}var t=XMLHttpRequest;XMLHttpRequest.prototype,(window||self).XMLHttpRequest=e,e.UNSENT=0,e.OPENED=1,e.HEADERS_RECEIVED=2,e.LOADING=4,e.DONE=4,e.prototype.open=function(e,n,r,i,o){var s=local.parseUri(n);return"httpl"!=s.protocol?(Object.defineProperty(this,"__xhr_request",{value:new t}),this.__xhr_request.open(e,n,r,i,o)):(Object.defineProperty(this,"__local_request",{value:new local.Request({method:e,url:n,stream:!0})}),i&&this.__local_request.setHeader("Authorization","Basic "+btoa(i+":"+o)),this.readyState=1,this.onreadystatechange&&this.onreadystatechange(),void 0)},e.prototype.send=function(e){var t=this;if(!this.__local_request)return this.__xhr_request.onreadystatechange=function(){for(var e in this)"function"!=typeof this[e]&&(t[e]=this[e]);t.onreadystatechange&&t.onreadystatechange()},this.__xhr_request.send(e);var n=local.dispatch(this.__local_request);this.__local_request.end(e),n.always(function(e){Object.defineProperty(t,"__local_response",{value:e}),t.readyState=2,t.status=e.status,t.statusText=e.status+" "+e.reason,t.responseText=null,t.onreadystatechange&&t.onreadystatechange(),e.on("data",function(e){t.readyState=3,null===t.responseText&&"string"==typeof e&&(t.responseText=""),t.responseText+=e,t.onreadystatechange&&t.onreadystatechange()}),e.on("end",function(){switch(t.readyState=4,t.responseType){case"json":t.response=e.body;break;case"text":default:t.response=t.responseText}t.onreadystatechange&&t.onreadystatechange(),t.onload&&t.onload()})})},e.prototype.abort=function(){return this.__local_request?this.__local_request.close():this.__xhr_request.abort()},e.prototype.setRequestHeader=function(e,t){return this.__local_request?this.__local_request.setHeader(e.toLowerCase(),t):this.__xhr_request.setRequestHeader(e,t)},e.prototype.getAllResponseHeaders=function(e){return this.__local_request?this.__local_response?this.__local_response.headers:null:this.__xhr_request.getAllResponseHeaders(e)},e.prototype.getResponseHeader=function(e){return this.__local_request?this.__local_response?this.__local_response.getHeader(e):null:this.__xhr_request.getResponseHeader(e)}};var B={serialize:r,deserialize:i,register:o},M={};local.contentTypes=B,local.contentTypes.register("application/json",function(e){try{return JSON.stringify(e)}catch(t){return t.message}},function(e){try{return JSON.parse(e)}catch(t){return t.message}}),local.contentTypes.register("application/x-www-form-urlencoded",function(e){var t=encodeURIComponent,n=[];for(var r in e)if(null===e[r])n.push(r+"=");else if(Array.isArray(e[r]))for(var i=0;i<e[r].length;i++)n.push(r+"[]="+t(e[r][i]));else if("object"==typeof e[r])for(var o in e[r])n.push(r+"["+o+"]="+t(e[r][o]));else n.push(r+"="+t(e[r]));return n.join("&")},function(e){for(var t=e.split("&"),n={},r=0;r<t.length;r++){var i=t[r].split("="),o=decodeURIComponent(i[0]),s=decodeURIComponent(i[1]),a=/\[\]$/.test(o),l=o.match(/^(.+)\[([^\]]+)\]$/);if("true"===s?s=!0:"false"===s?s=!1:+s==s&&(s=+s),l){o=l[1];var c=l[2];n[o]=n[o]||{},n[o][c]=s}else a?(o=o.substring(0,o.length-2),n[o]=n[o]||[],n[o].push(s)):n[o]=s}return n}),local.contentTypes.register("text/event-stream",function(e){var t="";return"undefined"!=typeof e.event&&(t+="event: "+e.event+"\r\n"),"undefined"!=typeof e.data&&(t+="data: "+JSON.stringify(e.data)+"\r\n"),t+"\r\n"},function(e){var t={};if(e.split("\r\n").forEach(function(e){/^[\s]*$/.test(e)||(e=l(e),e[0]&&(t[e[0]]=e[1]))}),t.data)try{t.data=JSON.parse(t.data)}catch(n){}return t});var z={serialize:c,deserialize:u,register:h},G={};local.httpHeaders=z;var W=/<(.*?)>(?:;[\s]*(.*?)((,(?=[\s]*<))|$))/g,V=/([\-a-z0-9_\.]+)=?(?:(?:"([^"]+)")|([^;\s]+))?/g;local.httpHeaders.register("link",function(e){var t=[];return e.forEach(function(e){var n=["<"+e.href+">"];for(var r in e)"href"!=r&&null!==e[r]&&("boolean"==typeof e[r]&&e[r]?n.push(r):n.push(r+'="'+e[r]+'"'));t.push(n.join("; "))}),t.join(", ")},function(e){for(var t,n,r,i=[];t=W.exec(e);){for(r={href:t[1]};n=V.exec(t[2]);)r[n[1]]=n[2]||n[3]||!0;i.push(r)}return i}),local.httpHeaders.register("accept",function(e){return e.map(function(e){var t=[e.full];1!==e.q&&t.push("q="+e.q);for(var n in e.params)t.push(n+"="+e.params[n]);return t.join("; ")}).join(", ")},function(e){return e.split(",").map(function(e){return d(e.trim())}).filter(function(e){return e&&e.q>0})});var J=/(?:([A-z]+)\/)?([\d\.]+) ([-A-z:\d\.@!]*)(?: ([^,]+))?/g;local.httpHeaders.register("via",function(e){return e.map(function(e){return(e.proto.name?e.proto.name+"/":"")+e.proto.version+" "+e.hostname+(e.comment?" "+e.comment:"")}).join(", ")},function(e){for(var t,n=[];t=J.exec(e);){var r={proto:{name:t[1],version:t[2]},hostname:t[3],comment:t[4]};n.push(r)}return n}),local.Request=p,p.prototype=Object.create(local.util.EventEmitter.prototype),p.prototype.setHeader=function(e,t){this.headers[e.toLowerCase()]=t},p.prototype.getHeader=function(e){return this.headers[e.toLowerCase()]},p.prototype.removeHeader=function(e){delete this.headers[e.toLowerCase()]},p.prototype.setTimeout=function(e){var t=this;this.__timeoutId||Object.defineProperty(this,"__timeoutId",{value:setTimeout(function(){t.isConnOpen&&t.close(),delete t.__timeoutId},e),configurable:!0,enumerable:!1,writable:!0})},p.prototype.serializeHeaders=function(){for(var e in this.headers)this.headers[e]=local.httpHeaders.serialize(e,this.headers[e])},p.prototype.deserializeHeaders=function(){for(var e in this.headers){var t=local.httpHeaders.deserialize(e,this.headers[e]);t&&"string"!=typeof t&&(this.parsedHeaders[e]=t)}},p.prototype.write=function(e){return this.isConnOpen?("string"!=typeof e&&(e=local.contentTypes.serialize(this.headers["content-type"],e)),this.emit("data",e),this):this},p.prototype.end=function(e){return this.isConnOpen?("undefined"!=typeof e&&this.write(e),this.emit("end"),this):this},p.prototype.close=function(){return this.isConnOpen?(this.isConnOpen=!1,this.emit("close"),this):this};var X=/_/g;local.Response=m,m.prototype=Object.create(local.util.EventEmitter.prototype),m.prototype.setHeader=function(e,t){this.headers[e.toLowerCase()]=t},m.prototype.getHeader=function(e){return this.headers[e.toLowerCase()]},m.prototype.removeHeader=function(e){delete this.headers[e.toLowerCase()]},m.prototype.serializeHeaders=function(){for(var e in this.headers)this.headers[e]=local.httpHeaders.serialize(e,this.headers[e])},m.prototype.deserializeHeaders=function(){for(var e in this.headers){var t=local.httpHeaders.deserialize(e,this.headers[e]);t&&"string"!=typeof t&&(this.parsedHeaders[e]=t)}},m.prototype.processHeaders=function(e){var t=this,n=t.parsedHeaders.via,r=local.viaToUri(n),i=function(e){for(var t=0;t<n.length;t++)e=decodeURIComponent(e);return e};t.parsedHeaders.link&&t.parsedHeaders.link.forEach(function(t){local.isAbsUri(t.href)||(t.href=local.joinRelPath(e.urld,t.href));var n=null;if(r&&0===t.href.indexOf(r)){var o=i(t.href.slice(r.length)).slice(1);/^http(s|l)?:\/\//.test(o)&&(n=local.parseUri(o).authority)}n||(n=local.parseUri(t.href).authority),Object.defineProperty(t,"host_domain",{enumerable:!1,configurable:!0,writable:!0,value:n});var s=local.parsePeerDomain(t.host_domain);s?(Object.defineProperty(t,"host_user",{enumerable:!1,configurable:!0,writable:!0,value:s.user}),Object.defineProperty(t,"host_relay",{enumerable:!1,configurable:!0,writable:!0,value:s.relay}),Object.defineProperty(t,"host_app",{enumerable:!1,configurable:!0,writable:!0,value:s.app}),Object.defineProperty(t,"host_sid",{enumerable:!1,configurable:!0,writable:!0,value:s.sid})):(delete t.host_user,delete t.host_relay,delete t.host_app,delete t.host_sid),r?Object.defineProperty(t,"host_proxy",{enumerable:!1,configurable:!0,writable:!0,value:r}):delete t.host_proxy})},m.prototype.writeHead=function(e,t,n){if(!this.isConnOpen)return this;if(this.status=e,this.reason=t,n)for(var r in n)n.hasOwnProperty(r)&&this.setHeader(r,n[r]);return this.serializeHeaders(),this.emit("headers",this),this},m.prototype.write=function(e){return this.isConnOpen?("string"!=typeof e&&(e=local.contentTypes.serialize(this.headers["content-type"],e)),this.emit("data",e),this):this},m.prototype.end=function(e){return this.isConnOpen?("undefined"!=typeof e&&this.write(e),this.emit("end"),this.close(),this):this},m.prototype.close=function(){return this.isConnOpen?(this.isConnOpen=!1,this.emit("close"),this):this};var $=/(^(.))|(\-(.))/g,Y=/\-/g;local.Server=w,w.prototype.getDomain=function(){return this.config.domain},w.prototype.getUrl=function(){return"httpl://"+this.config.domain},w.prototype.debugLog=function(){if(this.config.log){var e=[this.config.domain].concat([].slice.call(arguments));console.debug.apply(console,e)}},w.prototype.handleLocalRequest=function(e,t){console.warn("handleLocalRequest not defined",this),t.writeHead(501,"server not implemented"),t.end()},w.prototype.terminate=function(){},E.prototype=Object.create(w.prototype),local.BridgeServer=E,E.prototype.useMessageReordering=function(e){this.debugLog("turning "+(e?"on":"off")+" reordering"),this.isReorderingMessages=!!e},E.prototype.isChannelActive=function(){return console.warn("isChannelActive not defined",this),!1},E.prototype.channelSendMsg=function(e){console.warn("channelSendMsg not defined",this,e)},E.prototype.handleRemoteRequest=function(e,t){console.warn("handleRemoteRequest not defined",this),t.writeHead(501,"server not implemented"),t.end()},E.prototype.flushBufferedMessages=function(){this.debugLog("FLUSHING MESSAGES",this,JSON.stringify(this.msgBuffer)),this.msgBuffer.forEach(function(e){this.channelSendMsg(e)},this),this.msgBuffer.length=0},E.prototype.channelSendMsgWhenReady=function(e){this.isChannelActive()?this.channelSendMsg(e):this.msgBuffer.push(e)},E.prototype.handleLocalRequest=function(e,t){var n=this.sidCounter++,r={sid:n,mid:this.isReorderingMessages?1:void 0,method:e.method,path:e.path,host:e.host,query:e.query,headers:e.headers};
this.outgoingStreams[r.sid]=e,this.incomingStreams[-r.sid]=t,this.channelSendMsgWhenReady(JSON.stringify(r));var i=this,o=r.mid;e.on("data",function(e){i.channelSendMsgWhenReady(JSON.stringify({sid:n,mid:o?++o:void 0,body:e}))}),e.on("end",function(){i.channelSendMsgWhenReady(JSON.stringify({sid:n,mid:o?++o:void 0,end:!0}))}),e.on("close",function(){i.channelSendMsgWhenReady(JSON.stringify({sid:n,mid:o?++o:void 0,close:!0})),delete i.outgoingStreams[r.sid]})},E.prototype.terminate=function(){w.prototype.terminate.call(this);for(var e in this.incomingStreams)this.incomingStreams[e].end();for(e in this.outgoingStreams)this.outgoingStreams[e].end();this.incomingStreams=this.outgoingStreams={}},E.prototype.onChannelMessage=function(e){if("string"==typeof e){if(!C(e))return console.warn("Dropping malformed HTTPL message",e,this),void 0;e=JSON.parse(e)}if(!S(e))return console.warn("Dropping malformed HTTPL message",e,this),void 0;if(e.mid&&(this.incomingStreamsBuffer[e.sid]||(this.incomingStreamsBuffer[e.sid]={nextMid:1,cache:{}}),this.incomingStreamsBuffer[e.sid].nextMid!=e.mid))return this.incomingStreamsBuffer[e.sid].cache[e.mid]=e,void 0;var t=this.incomingStreams[e.sid];if(!t){if(!(e.sid>0))return console.warn("Dropping unexpected HTTPL response message",e,this),void 0;var n=new local.Request({method:e.method,host:e.host,path:e.path,query:e.query,headers:e.headers}),r=new local.Response;n.on("close",function(){r.close()});var i=this,o=-e.sid,s=this.isReorderingMessages?1:void 0;r.on("headers",function(){i.channelSendMsg(JSON.stringify({sid:o,mid:s?s++:void 0,status:r.status,reason:r.reason,headers:r.headers}))}),r.on("data",function(e){i.channelSendMsg(JSON.stringify({sid:o,mid:s?s++:void 0,body:e}))}),r.on("end",function(){i.channelSendMsg(JSON.stringify({sid:o,mid:s?s++:void 0,end:!0}))}),r.on("close",function(){i.channelSendMsg(JSON.stringify({sid:o,mid:s?s++:void 0,close:!0})),delete i.outgoingStreams[o]}),t=this.incomingStreams[e.sid]=n,this.outgoingStreams[o]=r,this.handleRemoteRequest(n,r)}if(e.sid<0&&"undefined"!=typeof e.status&&t.writeHead(e.status,e.reason,e.headers),e.body&&t.write(e.body),e.end&&t.end(),e.close)return t.close(),delete this.incomingStreams[e.sid],delete this.incomingStreamsBuffer[e.sid],void 0;if(e.mid){var a=++this.incomingStreamsBuffer[e.sid].nextMid;if(this.incomingStreamsBuffer[e.sid].cache[a]){var l=this.incomingStreamsBuffer[e.sid].cache[a];delete this.incomingStreamsBuffer[e.sid].cache[a],this.onChannelMessage(l)}}},T.prototype=Object.create(local.BridgeServer.prototype),local.WorkerBridgeServer=T,T.prototype.getPort=function(){return this.worker.port?this.worker.port:this.worker},T.prototype.terminate=function(){E.prototype.terminate.call(this),this.worker.terminate(),this.worker=null,this.isActive=!1},T.prototype.isChannelActive=function(){return this.isActive},T.prototype.channelSendMsg=function(e){this.config.log&&this.debugLog("sending to worker",e),this.getPort().postMessage(e)},E.prototype.handleRemoteRequest=function(e,t){this.configServerFn?this.configServerFn.call(this,e,t,this):(t.writeHead(501,"server not implemented"),t.end())},T.prototype.onWorkerReady=function(e){this.hasHostPrivileges=e.hostPrivileges,this.hasHostPrivileges&&this.channelSendMsg({op:"configure",body:this.config}),this.isActive=!0,this.flushBufferedMessages()},T.prototype.onWorkerLog=function(e){if(e){if(!Array.isArray(e))return console.error('Received invalid "log" operation: Payload must be an array',e);var t=e.shift(),n=["["+this.config.domain+"]"].concat(e);switch(t){case"error":console.error.apply(console,n);break;case"warn":console.warn.apply(console,n);break;default:console.log.apply(console,n)}}},function(){function e(){return Math.round(1e4*Math.random())}function t(e){if(e||(e={}),!e.peer)throw new Error("`config.peer` is required");if(!e.relay)throw new Error("`config.relay` is required");"undefined"==typeof e.retryTimeout&&(e.retryTimeout=15e3),"undefined"==typeof e.retries&&(e.retries=3),local.BridgeServer.call(this,e),local.util.mixinEventEmitter(this);var t=local.parsePeerDomain(e.peer);if(!t)throw new Error("Invalid peer URL: "+e.peer);this.peerInfo=t,this.isConnecting=!0,this.isOfferExchanged=!1,this.isConnected=!1,this.isTerminated=!1,this.candidateQueue=[],this.offerNonce=0,this.retriesLeft=e.retries,this.rtcPeerConn=null,this.rtcDataChannel=null,this.createPeerConn(),this.config.loopback?(this.isOfferExchanged=!0,r.call(this)):this.config.initiate&&this.sendOffer()}function n(e){this.debugLog("HTTPL CHANNEL MSG",e),this.onChannelMessage(e.data)}function r(e){console.log("Successfully established WebRTC session with",this.config.peer),this.debugLog("HTTPL CHANNEL OPEN",e),this.isConnecting=!1,this.isConnected=!0,this.emit("connected",Object.create(this.peerInfo),this)}function i(e){console.log("Closed WebRTC session with",this.config.peer),this.debugLog("HTTPL CHANNEL CLOSE",e),this.terminate({noSignal:!0})}function o(e){this.debugLog("HTTPL CHANNEL ERR",e),this.emit("error",Object.create(this.peerInfo,{error:{value:e}}),this)}function s(){var e=this;setTimeout(function(){e.config.initiate&&e.isConnected===!1&&(e.retriesLeft>0?(e.retriesLeft--,e.debugLog("CONNECTION TIMED OUT, RESTARTING. TRIES LEFT:",e.retriesLeft),e.resetPeerConn(),e.sendOffer()):(console.log("Failed to establish WebRTC session with",e.config.peer," - Will continue bouncing traffic through the relay"),e.debugLog("CONNECTION TIMED OUT, GIVING UP"),e.resetPeerConn()))},this.config.retryTimeout)}function a(){var e=this;this.isOfferExchanged=!0,this.candidateQueue.forEach(function(t){e.rtcPeerConn.addIceCandidate(new b({candidate:t}))}),this.candidateQueue.length=0}function l(e){e&&e.candidate&&(this.debugLog("FOUND ICE CANDIDATE",e.candidate),this.signal({type:"candidate",candidate:e.candidate.candidate}))}function c(e){e.target&&"disconnected"===e.target.iceConnectionState&&(this.debugLog("ICE CONNECTION STATE CHANGE: DISCONNECTED",e),this.terminate({noSignal:!0}))}function u(e){e.target&&"closed"==e.target.signalingState&&(this.debugLog("SIGNALING STATE CHANGE: DISCONNECTED",e),this.terminate({noSignal:!0}))}function h(e){this.debugLog("DATA CHANNEL PROVIDED",e),this.rtcDataChannel=e.channel,this.rtcDataChannel.onopen=r.bind(this),this.rtcDataChannel.onclose=i.bind(this),this.rtcDataChannel.onerror=o.bind(this),this.rtcDataChannel.onmessage=n.bind(this)}function f(e){return e}function d(t){t||(t={}),t.app||(t.app=window.location.host),"undefined"==typeof t.sid&&(t.sid=e(),this.autoRetryStreamTaken=!0),"undefined"==typeof t.ping&&(t.ping=45e3),this.config=t,local.util.mixinEventEmitter(this),this.assignedDomain=null,this.connectionStatus=0,Object.defineProperty(this,"connectedToRelay",{get:function(){return this.connectionStatus==d.CONNECTED},set:function(e){this.connectionStatus=e?d.CONNECTED:d.DISCONNECTED}}),this.userId=null,this.accessToken=null,this.bridges={},this.pingInterval=null,this.registeredLinks=null,this.relayEventStream=null,this.messageFromAuthPopupHandler=null,this.relayService=null,this.usersCollection=null,this.relayItem=null,t.provider&&this.setProvider(t.provider),window.addEventListener("beforeunload",this.onPageClose.bind(this))}var p={optional:[{DtlsSrtpKeyAgreement:!0}]},g={iceServers:[{url:"stun:stun.l.google.com:19302"}]},y="undefined"!=typeof window?window:"undefined"!=typeof self?self:global,m=y.mozRTCSessionDescription||y.RTCSessionDescription,v=y.mozRTCPeerConnection||y.webkitRTCPeerConnection||y.RTCPeerConnection,b=y.mozRTCIceCandidate||y.RTCIceCandidate;t.prototype=Object.create(local.BridgeServer.prototype),local.RTCBridgeServer=t,t.prototype.getPeerInfo=function(){return this.peerInfo},t.prototype.terminate=function(e){E.prototype.terminate.call(this),this.isTerminated=!0,(this.isConnecting||this.isConnected)&&(e&&e.noSignal||this.signal({type:"disconnect"}),this.isConnecting=!1,this.isConnected=!1,this.destroyPeerConn(),this.emit("disconnected",Object.create(this.peerInfo),this))},t.prototype.isChannelActive=function(){return!0},t.prototype.channelSendMsg=function(e){if(this.config.loopback)this.onChannelMessage(e);else if(this.isConnected)try{this.rtcDataChannel.send(e),this.isReorderingMessages&&this.useMessageReordering(!1)}catch(t){this.debugLog("NETWORK ERROR, BOUNCING",t),this.signal({type:"httpl",data:e})}else this.signal({type:"httpl",data:e})},t.prototype.handleRemoteRequest=function(e,t){var n=this.config.relay.getServer();n&&"function"==typeof n?n.call(this,e,t,this):n&&n.handleRemoteRequest?n.handleRemoteRequest(e,t,this):(t.writeHead(501,"not implemented"),t.end())},t.prototype.onSignal=function(e){var t=this;switch(e.type){case"disconnect":this.terminate({noSignal:!0});break;case"candidate":this.debugLog("GOT CANDIDATE",e.candidate),this.isOfferExchanged?this.rtcPeerConn.addIceCandidate(new b({candidate:e.candidate})):this.candidateQueue.push(e.candidate);break;case"offer":if(this.debugLog("GOT OFFER",e),this.isConnected)return this.debugLog("RECEIVED AN OFFER WHEN BELIEVED TO BE CONNECTED, DROPPING"),void 0;if("undefined"==typeof m)return;if(this.isOfferExchanged||this.emit("connecting",Object.create(this.peerInfo),this),this.config.initiate&&(this.debugLog("LEADER CONFLICT DETECTED, COMPARING NONCES","MINE=",this.offerNonce,"THEIRS=",e.nonce),this.offerNonce<e.nonce&&(this.debugLog("RESETTING INTO FOLLOWER ROLE"),this.config.initiate=!1,this.resetPeerConn())),!this.config.initiate&&this.isOfferExchanged){if(!(this.retriesLeft>0))return this.debugLog("RECEIVED A NEW OFFER, NO RETRIES LEFT. GIVING UP."),this.terminate(),void 0;this.retriesLeft--,this.debugLog("RECEIVED A NEW OFFER, RESETTING AND RETRYING. RETRIES LEFT:",this.retriesLeft),this.resetPeerConn()}var n=new m({type:"offer",sdp:e.sdp});this.rtcPeerConn.setRemoteDescription(n),a.call(this),this.rtcPeerConn.createAnswer(function(e){t.debugLog("CREATED ANSWER",e),e.sdp=f(e.sdp),t.rtcPeerConn.setLocalDescription(e),t.signal({type:"answer",sdp:e.sdp})},function(e){t.emit("error",Object.create(this.peerInfo,{error:{value:e}}),t)});break;case"answer":this.debugLog("GOT ANSWER",e),this.rtcPeerConn.setRemoteDescription(new m({type:"answer",sdp:e.sdp})),a.call(this);break;case"httpl":this.debugLog("GOT HTTPL RELAY",e),this.onChannelMessage(e.data);break;default:console.warn("RTCBridgeServer - Unrecognized signal message from relay",e)}},t.prototype.signal=function(e){var t=this,n=this.config.relay.signal(this.config.peer,e);return n.fail(function(e){if(404==e.status&&!t.isTerminated){for(var n in t.incomingStreams)try{t.incomingStreams[n].writeHead(404,"not found").end()}catch(r){console.error("That weird peer 404 error",r,t.incomingStreams[n])}t.terminate({noSignal:!0}),local.removeServer(t.config.domain)}}),n},t.prototype.createPeerConn=function(){if(!this.rtcPeerConn&&"undefined"!=typeof v){var e=this.config.iceServers||g;this.rtcPeerConn=new v(e,p),this.rtcPeerConn.onicecandidate=l.bind(this),this.rtcPeerConn.oniceconnectionstatechange=c.bind(this),this.rtcPeerConn.onsignalingstatechange=u.bind(this),this.rtcPeerConn.ondatachannel=h.bind(this),this.useMessageReordering(!0)}},t.prototype.destroyPeerConn=function(e){this.rtcDataChannel&&(this.rtcDataChannel.close(),e&&(this.rtcDataChannel.onopen=null,this.rtcDataChannel.onclose=null,this.rtcDataChannel.onerror=null,this.rtcDataChannel.onmessage=null),this.rtcDataChannel=null),this.rtcPeerConn&&(this.rtcPeerConn.close(),e&&(this.rtcPeerConn.onicecandidate=null,this.rtcPeerConn.oniceconnectionstatechange=null,this.rtcPeerConn.onsignalingstatechange=null,this.rtcPeerConn.ondatachannel=null),this.rtcPeerConn=null)},t.prototype.resetPeerConn=function(){this.destroyPeerConn(!0),this.createPeerConn(),this.candidateQueue.length=0,this.isOfferExchanged=!1},t.prototype.sendOffer=function(){var e=this;if("undefined"!=typeof v){try{this.rtcDataChannel=this.rtcPeerConn.createDataChannel("httpl",{reliable:!0}),this.rtcDataChannel.onopen=r.bind(this),this.rtcDataChannel.onclose=i.bind(this),this.rtcDataChannel.onerror=o.bind(this),this.rtcDataChannel.onmessage=n.bind(this)}catch(t){return}s.call(this),this.rtcPeerConn.createOffer(function(t){e.debugLog("CREATED OFFER",t),t.sdp=f(t.sdp),e.rtcPeerConn.setLocalDescription(t),e.offerNonce=Math.round(1e7*Math.random()),e.signal({type:"offer",sdp:t.sdp,nonce:e.offerNonce})},function(t){e.emit("error",Object.create(this.peerInfo,{error:{value:t}}),e)}),local.util.nextTick(function(){e.emit("connecting",Object.create(e.peerInfo),e)})}},local.Relay=d,d.DISCONNECTED=0,d.CONNECTING=1,d.CONNECTED=2,d.prototype.setAccessToken=function(e){if("null"==e&&(e=null),e){var t=e.split(":");if(2!==t.length)throw new Error("Invalid access token");if(this.userId=t[0],this.accessToken=e,this.relayService){this.relayService.setRequestDefaults({headers:{authorization:"Bearer "+e}}),this.usersCollection.setRequestDefaults({headers:{authorization:"Bearer "+e}});var n=this;this.relayItem=this.relayService.follow({rel:"gwr.io/relay",user:this.getUserId(),app:this.getApp(),sid:this.getSid(),nc:Date.now()}),this.relayItem.resolve().then(function(){n.emit("accessGranted")},function(e){n.onRelayError({event:"error",data:e})})}}else{var r=!!this.accessToken;this.userId=null,this.accessToken=null,r&&this.emit("accessRemoved")}},d.prototype.isListening=function(){return this.connectedToRelay},d.prototype.getAssignedDomain=function(){return this.assignedDomain},d.prototype.getAssignedUrl=function(){return"httpl://"+this.assignedDomain},d.prototype.getUserId=function(){return this.userId},d.prototype.getApp=function(){return this.config.app},d.prototype.setApp=function(e){this.config.app=e},d.prototype.getStreamId=function(){return this.config.sid},d.prototype.getSid=d.prototype.getStreamId,d.prototype.setStreamId=function(e){this.config.sid=e},d.prototype.setSid=d.prototype.setStreamId,d.prototype.getAccessToken=function(){return this.accessToken},d.prototype.getServer=function(){return this.config.serverFn},d.prototype.setServer=function(e){this.config.serverFn=e},d.prototype.getRetryTimeout=function(){return this.config.retryTimeout},d.prototype.setRetryTimeout=function(e){this.config.retryTimeout=e},d.prototype.getProvider=function(){return this.config.provider},d.prototype.setProvider=function(e){if(this.connectedToRelay)throw new Error("Can not change provider while connected to the relay. Call stopListening() first.");this.config.provider=e,this.providerDomain=local.parseUri(e).authority,this.relayService=local.agent(this.config.provider),this.usersCollection=this.relayService.follow({rel:"gwr.io/users"}),this.accessToken&&(this.relayService.setRequestDefaults({headers:{authorization:"Bearer "+this.accessToken}}),this.usersCollection.setRequestDefaults({headers:{authorization:"Bearer "+this.accessToken}}))},d.prototype.requestAccessToken=function(e){this.messageFromAuthPopupHandler||(this.messageFromAuthPopupHandler=function(e){var t=local.parseUri(e.origin),n=local.parseUri(this.config.provider);t.authority===n.authority&&(console.log("Received access token from "+e.origin),this.config.provider!=e.origin&&this.setProvider(e.origin),this.setAccessToken(e.data),e.data||this.emit("accessDenied"))}.bind(this),window.addEventListener("message",this.messageFromAuthPopupHandler));var t=this.getProvider()+"/session/"+this.config.app;e&&e.guestof&&(t+="?guestof="+encodeURIComponent(e.guestof)),window.open(t)},d.prototype.getUsers=function(e){var t=this.usersCollection;return e&&(e.rel="self",t=t.follow(e)),t.get({Accept:"application/json"})},d.prototype.getUser=function(e){return this.usersCollection.follow({rel:"gwr.io/user",id:e}).get({Accept:"application/json"})},d.prototype.registerLinks=function(e){this.registeredLinks=Array.isArray(e)?e:[e],this.relayItem&&this.relayItem.dispatch({method:"PATCH",body:{links:this.registeredLinks}})},d.prototype.agent=function(){return this.relayService?this.relayService.follow({rel:"gwr.io/relays",links:1}):local.agent()},d.prototype.startListening=function(){var e=this;if(this.getAccessToken()){if(this.connectionStatus!==d.DISCONNECTED)return console.error("startListening() called when already connected or connecting to relay. Must call stopListening() first."),void 0;this.assignedDomain=this.makeDomain(this.getUserId(),this.config.app,this.config.sid),0===this.config.sid&&(this.assignedDomain+="!0"),this.relayItem=this.relayService.follow({rel:"gwr.io/relay",user:this.getUserId(),app:this.getApp(),sid:this.getSid(),nc:Date.now()}),this.connectionStatus=d.CONNECTING,this.relayItem.subscribe().then(function(t){nt[e.providerDomain]=e,e.relayEventStream=t,e.connectionStatus=d.CONNECTED,t.response_.then(function(t){return e.registeredLinks&&e.registerLinks(e.registeredLinks),e.emit("listening"),t}),t.on("signal",e.onSignal.bind(e)),t.on("error",e.onRelayError.bind(e)),t.on("close",e.onRelayClose.bind(e)),e.pingInterval&&clearInterval(e.pingInterval),e.config.ping&&(e.pingInterval=setInterval(function(){e.signal(e.getAssignedDomain(),{type:"noop"})},e.config.ping))},function(t){e.onRelayError({event:"error",data:t})})}},d.prototype.stopListening=function(){if(this.connectedToRelay){for(var e in this.bridges)this.bridges[e].isConnecting&&this.bridges[e].terminate();this.connectedToRelay=!1,this.relayEventStream.close(),this.relayEventStream=null,delete nt[this.providerDomain]}},d.prototype.connect=function(e,t){t||(t={}),"undefined"==typeof t.initiate&&(t.initiate=!0),e=local.parseUri(e).authority;var n=local.parsePeerDomain(e);if(!n)throw new Error("Invalid peer url given to connect(): "+e);if(0===n.sid&&"!0"!=e.slice(-2)&&(e+="!0"),e in this.bridges)return this.bridges[e];console.log("Initiating WebRTC session with",e);var r=new local.RTCBridgeServer({peer:e,initiate:t.initiate,relay:this,serverFn:this.config.serverFn,loopback:e==this.assignedDomain,retryTimeout:t.retryTimeout||this.config.retryTimeout,retries:t.retries||this.config.retries,log:this.config.log||!1});return r.on("connecting",this.emit.bind(this,"connecting")),r.on("connected",this.emit.bind(this,"connected")),r.on("disconnected",this.onBridgeDisconnected.bind(this)),r.on("disconnected",this.emit.bind(this,"disconnected")),r.on("error",this.emit.bind(this,"error")),this.bridges[e]=r,local.addServer(e,r),r},d.prototype.signal=function(e,t){if(!this.relayItem)return console.warn("Relay - signal() called before relay is connected"),void 0;var n=this,r=this.relayItem.dispatch({method:"notify",body:{src:this.assignedDomain,dst:e,msg:t}});return r.fail(function(e){if(401==e.status){if(!n.accessToken)return;n.setAccessToken(null),n.emit("accessInvalid")}}),r},d.prototype.onSignal=function(e){if(e.data&&e.data.src&&e.data.msg||console.warn("discarding faulty signal message",err),"noop"!=e.data.msg.type){var t=e.data.src,n=this.bridges[t]||this.bridges[t+"!0"];n?n.onSignal(e.data.msg):("offer"==e.data.msg.type||"httpl"==e.data.msg.type)&&(n=this.connect(t,{initiate:!1}),n.onSignal(e.data.msg))}},d.prototype.onRelayError=function(t){if(t.data&&423==t.data.status)this.relayEventStream=null,this.connectedToRelay=!1,this.autoRetryStreamTaken?(this.setSid(e()),this.startListening()):this.emit("streamTaken");else if(t.data&&420==t.data.status)this.relayEventStream=null,this.connectedToRelay=!1,this.emit("outOfStreams");else if(!t.data||401!=t.data.status&&403!=t.data.status)if(t.data&&(0===t.data.status||404==t.data.status||t.data.status>=500)){this.connectedToRelay&&this.onRelayClose(),this.connectedToRelay=!1,this.relayEventStream=null;var n=this;setTimeout(function(){n.startListening()},2e3)}else this.emit("error",{error:t.data});else this.setAccessToken(null),this.connectedToRelay=!1,this.emit("accessInvalid")},d.prototype.onRelayClose=function(){this.connectedToRelay=!1,self.pingInterval&&clearInterval(self.pingInterval),this.emit("notlistening")},d.prototype.onBridgeDisconnected=function(e){var t=this.bridges[e.domain];t&&(delete this.bridges[e.domain],local.removeServer(e.domain))},d.prototype.onPageClose=function(){var e=Object.keys(this.bridges);if(this.connectedToRelay&&0!==e.length){var t=[];for(var n in this.bridges)t.push(this.bridges[n].config.peer);var r=new XMLHttpRequest;r.open("NOTIFY",this.relayItem.context.url,!1),r.setRequestHeader("Authorization","Bearer "+this.accessToken),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify({src:this.assignedDomain,dst:t,msg:{type:"disconnect"}}))}},d.prototype.makeDomain=function(e,t,n){return local.makePeerDomain(e,this.providerDomain,t,n)},local.logWebRTC=function(e){"undefined"==typeof e&&(e=!0);for(var t in nt)nt[t].config.log=e;for(var t in local.getServers()){var n=local.getServer(t);n.context&&n.context instanceof local.RTCBridgeServer&&(n.context.config.log=e)}}}();var K={register:R,unregister:A,get:O},Q={};local.schemes=K,local.schemes.register(["http","https"],function(e,t){var n=local.parseUri(e.url);if(e.query){var r=local.contentTypes.serialize("application/x-www-form-urlencoded",e.query);r&&(n.query?(n.query+="&"+r,n.relative+="&"+r):(n.query=r,n.relative+="?"+r))}var i=(n.protocol?n.protocol+"://":"//")+n.authority+n.relative,o=new XMLHttpRequest;o.open(e.method,i,!0),e.binary&&(o.responseType="arraybuffer",e.stream&&console.warn("Got HTTP/S request with binary=true and stream=true - sorry, not supported, binary responses must be buffered (its a browser thing)",e)),e.serializeHeaders();for(var s in e.headers)null!==e.headers[s]&&e.headers.hasOwnProperty(s)&&o.setRequestHeader(s,e.headers[s]);var a="";e.on("data",function(e){a+=e}),e.on("end",function(){o.send(a)}),e.on("close",function(){o.readyState!==XMLHttpRequest.DONE&&(o.aborted=!0,o.abort())});var l=0,c=0,u=!1;o.onreadystatechange=function(){if(o.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!u){u=!0;var e={};if(0!==o.status)if(o.getAllResponseHeaders())o.getAllResponseHeaders().split("\n").forEach(function(t){if(t){var n=t.replace("\r","").split(": ");e[n[0].toLowerCase()]=n.slice(1).join(": ")}});else{var n=function(t){var n=o.getResponseHeader(t);n&&(e[t.toLowerCase()]=n.toLowerCase())};n("Accept-Ranges"),n("Age"),n("Allow"),n("Cache-Control"),n("Connection"),n("Content-Encoding"),n("Content-Language"),n("Content-Length"),n("Content-Location"),n("Content-MD5"),n("Content-Disposition"),n("Content-Range"),n("Content-Type"),n("Date"),n("ETag"),n("Expires"),n("Last-Modified"),n("Link"),n("Location"),n("Pragma"),n("Refresh"),n("Retry-After"),n("Server"),n("Set-Cookie"),n("Trailer"),n("Transfer-Encoding"),n("Vary"),n("Via"),n("Warning"),n("WWW-Authenticate")}t.writeHead(o.status,o.statusText,e),t.binary||(l=setInterval(function(){var e=o.response.length;if(e>c){var n=o.response.slice(c);c=e,t.write(n)}},50))}o.readyState===XMLHttpRequest.DONE&&(l&&clearInterval(l),0===t.status||0!==o.status||o.aborted?(o.response&&t.write(o.response.slice(c)),t.end()):(console.debug("XHR looks like it timed out; treating it as a premature close"),t.close()))}});var Z={fn:function(e,t){t.writeHead(404,"server not found"),t.end()},context:null},et={fn:function(e,t){t.writeHead(407,"peer relay not authenticated"),t.end()},context:null};local.schemes.register("httpl",function(e,t){var n=local.getServer(e.urld.authority);if(!n){var r=local.parsePeerDomain(e.urld.authority);r?(0==r.sid&&("!0"==e.urld.authority.slice(-2)?n=local.getServer(e.urld.authority.slice(0,-2)):(e.urld.authority+="!0",n=local.getServer(e.urld.authority))),n||(r.relay in nt?(nt[r.relay].connect(e.urld.authority),n=local.getServer(e.urld.authority)):n=et)):n=Z}if(e.deserializeHeaders(),e.path=e.urld.path,e.host=e.urld.authority,e.path=e.path?e.path.replace(/(.)\/$/,"$1"):"/",e.urld.query){var i=local.contentTypes.deserialize("application/x-www-form-urlencoded",e.urld.query);e.query||(e.query={});for(var o in i)e.query[o]=i[o]}e.binary&&console.warn("Got HTTPL request with binary=true - sorry, not currently supported",e),n.fn.call(n.context,e,t)}),local.schemes.register("data",function(e,t){for(var n,r=e.url.indexOf(":"),i=e.url.indexOf(","),o=e.url.slice(r+1,i).split(";"),s=o.shift(),a=!1;n=o.shift();)"base64"==n&&(a=!0);var l=e.url.slice(i+1);l||(l=""),l=a?atob(l):decodeURIComponent(l),local.util.nextTick(function(){t.writeHead(200,"ok",{"content-type":s}),t.end(l)})});var tt={},nt={};local.addServer=function(e,t,n){if(tt[e])throw new Error("server already registered at domain given to addServer");var r=t instanceof local.Server;r&&(n=t,t=t.handleLocalRequest,n.config.domain=e),tt[e]={fn:t,context:n}},local.removeServer=function(e){tt[e]&&delete tt[e]},local.getServer=function(e){return tt[e]},local.getServers=function(){return tt};var rt;local.dispatch=function(e){if(!e)throw new Error("No request provided to dispatch()");"string"==typeof e&&(e={url:e});var t=null,n=!1;if(!(e instanceof local.Request)){n=!0;var r=e.timeout;e=new local.Request(e),r&&e.setTimeout(r),t=e.body,e.body=""}if(!e.url)throw new Error("No url on request");var i=x(e.url);if("nav"==i){var o=e.url;delete e.url;var s=local.agent(o).dispatch(e);return n&&e.end(t),s}if(Object.defineProperty(e,"urld",{value:local.parseUri(e.url),configurable:!0,enumerable:!1,writable:!0}),e.urld.query){var a=local.contentTypes.deserialize("application/x-www-form-urlencoded",e.urld.query);for(var l in a)e.query[l]=a[l];e.urld.relative=e.urld.path+(e.urld.anchor?"#"+e.urld.anchor:""),e.url=i+"://"+e.urld.authority+e.urld.relative}e.serializeHeaders();var c,u=new local.Response,s=local.promise();e.on("close",function(){u.close()}),u.on("headers",function(){u.deserializeHeaders(),u.processHeaders(e)}),u.on("close",function(){u.latency=Date.now()-c,e.close()}),e.stream?u.on("headers",function(e){local.fulfillResponsePromise(s,e)}):u.on("close",function(){local.fulfillResponsePromise(s,u)}),e.suspendEvents(),u.suspendEvents();var h=function(e,r,o){return c=Date.now(),o=o||local.schemes.get(i),o?(o(e,r),e.resumeEvents(),r.resumeEvents(),n&&e.end(t)):(r.writeHead(0,'unsupported scheme "'+i+'"'),r.end(),e.resumeEvents(),r.resumeEvents()),s},f=Array.prototype.slice.call(arguments,1);return f.unshift(h),f.unshift(u),f.unshift(e),local.util.nextTick(function(){rt.apply(null,f)}),s.request=e,s},local.fulfillResponsePromise=function(e,t){t.status>=200&&t.status<400?e.fulfill(t):t.status>=400&&t.status<600||0===t.status?e.reject(t):e.fulfill(t)},local.setDispatchWrapper=function(e){rt=e},local.setDispatchWrapper(function(e,t,n){n(e,t)}),function(){function e(e){return function(t){var n=t||{};return"string"==typeof n&&(n={url:n}),n.method=e,this.dispatch(n)}}function t(e){return function(t,n){var r=n||{};return"string"==typeof r&&(r={url:r}),r.method=e,r.body=t,this.dispatch(r)}}local.SUBSCRIBE=e("SUBSCRIBE"),local.HEAD=e("HEAD"),local.GET=e("GET"),local.DELETE=e("DELETE"),local.POST=t("POST"),local.PUT=t("PUT"),local.PATCH=t("PATCH"),local.NOTIFY=t("NOTIFY")}(),local.subscribe=function(e){"string"==typeof e&&(e={url:e}),e.stream=!0,e.method||(e.method="SUBSCRIBE"),e.headers||(e.headers={accept:"text/event-stream"}),e.headers.accept||(e.headers.accept="text/event-stream");var t=local.dispatch(e);return new L(t.request,t)},local.EventStream=L,L.prototype=Object.create(local.util.EventEmitter.prototype),L.prototype.getUrl=function(){return this.request.url},L.prototype.connect=function(e){var t,n=this,r="";this.response_=e,e.then(function(e){return n.isConnOpen=!0,n.response=e,e.on("data",function(i){for(i=r+i;-1!==(t=i.indexOf("\r\n\r\n"));){var o=i.slice(0,t);q.call(n,o),i=i.slice(t+4)}r=i,e.body=""}),e.on("end",function(){n.close()}),e.on("close",function(){n.isConnOpen&&n.reconnect()}),e},function(e){throw n.response=e,_.call(n,{event:"error",data:e}),n.close(),e})},L.prototype.reconnect=function(){this.isConnOpen&&(this.isConnOpen=!1,this.request.close()),local.util.isAppClosing||(this.request=new local.Request(this.request),this.request.headers||(this.request.headers={}),this.lastEventId&&(this.request.headers["last-event-id"]=this.lastEventId),this.connect(local.dispatch(this.request)),this.request.end())},L.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.request.close(),this.emit("close"))},local.EventHost=D,D.prototype.addStream=function(e){e.broadcastStreamId=this.streams.length,this.streams.push(e);var t=this;return e.on("close",function(){t.endStream(e)}),e.broadcastStreamId},D.prototype.endStream=function(e){"number"==typeof e&&(e=this.streams[e]),delete this.streams[e.broadcastStreamId],e.end()},D.prototype.endAllStreams=function(){this.streams.forEach(function(e){e.end()}),this.streams.length=0},D.prototype.emit=function(e,t,n){n||(n={}),n.exclude&&(Array.isArray(n.exclude)||(n.exclude=[n.exclude]),n.exclude=n.exclude.map(function(e){return e instanceof local.Response?e.broadcastStreamId:e},this)),this.streams.forEach(function(r,i){n.exclude&&-1!==n.exclude.indexOf(i)||this.emitTo(r,e,t)},this)},D.prototype.emitTo=function(e,t,n){"number"==typeof e&&(e=this.streams[e]),e.write({event:t,data:n}),e.body=""},function(e){"use strict";function t(e){var n;if(null===e||void 0===e)return!1;if(r.isArray(e))return e.length>0;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;for(n in e)if(e.hasOwnProperty(n)&&t(e[n]))return!0;return!1}var n=function(){function e(e){this.options=e}return e.prototype.toString=function(){return JSON&&JSON.stringify?JSON.stringify(this.options):this.options},e}(),r=function(){function e(e){return"[object Array]"===Object.prototype.toString.apply(e)}function t(e){return"[object String]"===Object.prototype.toString.apply(e)}function n(e){return"[object Number]"===Object.prototype.toString.apply(e)}function r(e){return"[object Boolean]"===Object.prototype.toString.apply(e)}function i(e,t){var n,r="",i=!0;for(n=0;n<e.length;n+=1)i?i=!1:r+=t,r+=e[n];return r}function o(e,t){for(var n=[],r=0;r<e.length;r+=1)n.push(t(e[r]));return n}function s(e,t){for(var n=[],r=0;r<e.length;r+=1)t(e[r])&&n.push(e[r]);return n}function a(e){if("object"!=typeof e||null===e)return e;Object.freeze(e);var t,n;for(n in e)e.hasOwnProperty(n)&&(t=e[n],"object"==typeof t&&l(t));return e}function l(e){return"function"==typeof Object.freeze?a(e):e}return{isArray:e,isString:t,isNumber:n,isBoolean:r,join:i,map:o,filter:s,deepFreeze:l}}(),i=function(){function e(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e}function t(e){return e>="0"&&"9">=e}function n(e){return t(e)||e>="a"&&"f">=e||e>="A"&&"F">=e}return{isAlpha:e,isDigit:t,isHexDigit:n}}(),o=function(){function e(e){return e.length>1?e:"0"+e}function t(t){var n,r,i="",o=a.encode(t);for(r=0;r<o.length;r+=1)n=o.charCodeAt(r),i+="%"+e(n.toString(16).toUpperCase());return i}function n(e,t){return"%"===e.charAt(t)&&i.isHexDigit(e.charAt(t+1))&&i.isHexDigit(e.charAt(t+2))}function r(e,t){return parseInt(e.substr(t,2),16)}function o(e){if(!n(e,0))return!1;var t=r(e,1),i=a.numBytes(t);if(0===i)return!1;for(var o=1;i>o;o+=1)if(!n(e,3*o)||!a.isValidFollowingCharCode(r(e,3*o+1)))return!1;return!0}function s(e,t){var i=e.charAt(t);if(!n(e,t))return i;var o=r(e,t+1),s=a.numBytes(o);if(0===s)return i;for(var l=1;s>l;l+=1)if(!n(e,t+3*l)||!a.isValidFollowingCharCode(r(e,t+3*l+1)))return i;return e.substr(t,3*s)}var a={encode:function(e){return unescape(encodeURIComponent(e))},numBytes:function(e){return 127>=e?1:e>=194&&223>=e?2:e>=224&&239>=e?3:e>=240&&244>=e?4:0},isValidFollowingCharCode:function(e){return e>=128&&191>=e}};return{encodeCharacter:t,isPctEncoded:o,pctCharAt:s}}(),s=function(){function e(e){return i.isAlpha(e)||i.isDigit(e)||"_"===e||o.isPctEncoded(e)}function t(e){return i.isAlpha(e)||i.isDigit(e)||"-"===e||"."===e||"_"===e||"~"===e}function n(e){return":"===e||"/"===e||"?"===e||"#"===e||"["===e||"]"===e||"@"===e||"!"===e||"$"===e||"&"===e||"("===e||")"===e||"*"===e||"+"===e||","===e||";"===e||"="===e||"'"===e}return{isVarchar:e,isUnreserved:t,isReserved:n}}(),a=function(){function e(e,t){var n,r="",i="";for(("number"==typeof e||"boolean"==typeof e)&&(e=e.toString()),n=0;n<e.length;n+=i.length)i=e.charAt(n),r+=s.isUnreserved(i)||t&&s.isReserved(i)?i:o.encodeCharacter(i);return r}function t(t){return e(t,!0)}function n(e,t){var n=o.pctCharAt(e,t);
return n.length>1?n:s.isReserved(n)||s.isUnreserved(n)?n:o.encodeCharacter(n)}function r(e){var t,n="",r="";for(t=0;t<e.length;t+=r.length)r=o.pctCharAt(e,t),n+=r.length>1?r:s.isReserved(r)||s.isUnreserved(r)?r:o.encodeCharacter(r);return n}return{encode:e,encodePassReserved:t,encodeLiteral:r,encodeLiteralCharacter:n}}(),l=function(){function e(e){t[e]={symbol:e,separator:"?"===e?"&":""===e||"+"===e||"#"===e?",":e,named:";"===e||"&"===e||"?"===e,ifEmpty:"&"===e||"?"===e?"=":"",first:"+"===e?"":e,encode:"+"===e||"#"===e?a.encodePassReserved:a.encode,toString:function(){return this.symbol}}}var t={};return e(""),e("+"),e("#"),e("."),e("/"),e(";"),e("?"),e("&"),{valueOf:function(e){return t[e]?t[e]:"=,!@|".indexOf(e)>=0?null:t[""]}}}(),c=function(){function e(e){this.literal=a.encodeLiteral(e)}return e.prototype.expand=function(){return this.literal},e.prototype.toString=e.prototype.expand,e}(),u=function(){function e(e){function t(){var t=e.substring(d,c);if(0===t.length)throw new n({expressionText:e,message:"a varname must be specified",position:c});f={varname:t,exploded:!1,maxLength:null},d=null}function r(){if(p===c)throw new n({expressionText:e,message:"after a ':' you have to specify the length",position:c});f.maxLength=parseInt(e.substring(p,c),10),p=null}var a,c,u=[],f=null,d=null,p=null,g="";for(a=function(t){var r=l.valueOf(t);if(null===r)throw new n({expressionText:e,message:"illegal use of reserved operator",position:c,operator:t});return r}(e.charAt(0)),c=a.symbol.length,d=c;c<e.length;c+=g.length){if(g=o.pctCharAt(e,c),null!==d){if("."===g){if(d===c)throw new n({expressionText:e,message:"a varname MUST NOT start with a dot",position:c});continue}if(s.isVarchar(g))continue;t()}if(null!==p){if(c===p&&"0"===g)throw new n({expressionText:e,message:"A :prefix must not start with digit 0",position:c});if(i.isDigit(g)){if(c-p>=4)throw new n({expressionText:e,message:"A :prefix must have max 4 digits",position:c});continue}r()}if(":"!==g)if("*"!==g){if(","!==g)throw new n({expressionText:e,message:"illegal character",character:g,position:c});u.push(f),f=null,d=c+1}else{if(null===f)throw new n({expressionText:e,message:"exploded without varspec",position:c});if(f.exploded)throw new n({expressionText:e,message:"exploded twice",position:c});if(f.maxLength)throw new n({expressionText:e,message:"an explode (*) MUST NOT follow to a prefix",position:c});f.exploded=!0}else{if(null!==f.maxLength)throw new n({expressionText:e,message:"only one :maxLength is allowed per varspec",position:c});if(f.exploded)throw new n({expressionText:e,message:"an exploeded varspec MUST NOT be varspeced",position:c});p=c+1}}return null!==d&&t(),null!==p&&r(),u.push(f),new h(e,a,u)}function t(t){var r,i,o=[],s=null,a=0;for(r=0;r<t.length;r+=1)if(i=t.charAt(r),null===a){if(null===s)throw new Error("reached unreachable code");if("{"===i)throw new n({templateText:t,message:"brace already opened",position:r});if("}"===i){if(s+1===r)throw new n({templateText:t,message:"empty braces",position:s});try{o.push(e(t.substring(s+1,r)))}catch(l){if(l.prototype===n.prototype)throw new n({templateText:t,message:l.options.message,position:s+l.options.position,details:l.options});throw l}s=null,a=r+1}}else{if("}"===i)throw new n({templateText:t,message:"unopened brace closed",position:r});"{"===i&&(r>a&&o.push(new c(t.substring(a,r))),a=null,s=r)}if(null!==s)throw new n({templateText:t,message:"unclosed brace",position:s});return a<t.length&&o.push(new c(t.substr(a))),new f(t,o)}return t}(),h=function(){function e(e){return JSON&&JSON.stringify?JSON.stringify(e):e}function n(e){if(!t(e))return!0;if(r.isString(e))return""===e;if(r.isNumber(e)||r.isBoolean(e))return!1;if(r.isArray(e))return 0===e.length;for(var n in e)if(e.hasOwnProperty(n))return!1;return!0}function i(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push({name:t,value:e[t]});return n}function o(e,t,n){this.templateText=e,this.operator=t,this.varspecs=n}function s(e,t,n){var r="";if(n=n.toString(),t.named){if(r+=a.encodeLiteral(e.varname),""===n)return r+=t.ifEmpty;r+="="}return null!==e.maxLength&&(n=n.substr(0,e.maxLength)),r+=t.encode(n)}function l(e){return t(e.value)}function c(e,o,s){var c=[],u="";if(o.named){if(u+=a.encodeLiteral(e.varname),n(s))return u+=o.ifEmpty;u+="="}return r.isArray(s)?(c=s,c=r.filter(c,t),c=r.map(c,o.encode),u+=r.join(c,",")):(c=i(s),c=r.filter(c,l),c=r.map(c,function(e){return o.encode(e.name)+","+o.encode(e.value)}),u+=r.join(c,",")),u}function u(e,o,s){var c=r.isArray(s),u=[];return c?(u=s,u=r.filter(u,t),u=r.map(u,function(t){var r=a.encodeLiteral(e.varname);return r+=n(t)?o.ifEmpty:"="+o.encode(t)})):(u=i(s),u=r.filter(u,l),u=r.map(u,function(e){var t=a.encodeLiteral(e.name);return t+=n(e.value)?o.ifEmpty:"="+o.encode(e.value)})),r.join(u,o.separator)}function h(e,n){var o=[],s="";return r.isArray(n)?(o=n,o=r.filter(o,t),o=r.map(o,e.encode),s+=r.join(o,e.separator)):(o=i(n),o=r.filter(o,function(e){return t(e.value)}),o=r.map(o,function(t){return e.encode(t.name)+"="+e.encode(t.value)}),s+=r.join(o,e.separator)),s}return o.prototype.toString=function(){return this.templateText},o.prototype.expand=function(i){var o,a,l,f,d=[],p=!1,g=this.operator;for(o=0;o<this.varspecs.length;o+=1)if(a=this.varspecs[o],l=i[a.varname],null!==l&&void 0!==l)if(a.exploded&&(p=!0),f=r.isArray(l),"string"==typeof l||"number"==typeof l||"boolean"==typeof l)d.push(s(a,g,l));else{if(a.maxLength&&t(l))throw new Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+e(l));a.exploded?t(l)&&(g.named?d.push(u(a,g,l)):d.push(h(g,l))):(g.named||!n(l))&&d.push(c(a,g,l))}return 0===d.length?"":g.first+r.join(d,g.separator)},o}(),f=function(){function e(e,t){this.templateText=e,this.expressions=t,r.deepFreeze(this)}return e.prototype.toString=function(){return this.templateText},e.prototype.expand=function(e){var t,n="";for(t=0;t<this.expressions.length;t+=1)n+=this.expressions[t].expand(e);return n},e.parse=u,e.UriTemplateError=n,e}();e(f)}(function(e){"use strict";local.UriTemplate=e}),P.UNRESOLVED=0,P.RESOLVED=1,P.FAILED=2,P.prototype.isResolved=function(){return this.resolveState===P.RESOLVED},P.prototype.isBad=function(){return this.resolveState===P.FAILED},P.prototype.isRelative=function(){return!this.queryIsAbsolute},P.prototype.isAbsolute=function(){return this.queryIsAbsolute},P.prototype.getUrl=function(){return this.url},P.prototype.getError=function(){return this.error},P.prototype.resetResolvedState=function(){this.resolveState=P.UNRESOLVED,this.error=null},P.prototype.setResolved=function(e){this.error=null,this.resolveState=P.RESOLVED,e&&(this.url=e,this.urld=local.parseUri(this.url))},P.prototype.setFailed=function(e){this.error=e,this.resolveState=P.FAILED},local.Agent=k,k.prototype.setRequestDefaults=function(e){this.requestDefaults=e},k.prototype.dispatch=function(e){e||(e={}),e.headers||(e.headers={});var t=this;return this.requestDefaults&&N(e,this.requestDefaults),e instanceof local.Request&&e.suspendEvents(),(e.url?local.promise(e.url):this.resolve({noretry:e.noretry,nohead:!0})).succeed(function(t){e.url=t;var n=local.dispatch(e);return e instanceof local.Request&&e.resumeEvents(),n}).succeed(function(e){return t.context.setResolved(),t.links=e.parsedHeaders.link?e.parsedHeaders.link:t.links||[],e}).fail(function(e){throw(e.status===local.LINK_NOT_FOUND||404===e.status)&&t.context.setFailed(e),e})},k.prototype.subscribe=function(e){var t,n=this;return e||(e={}),this.resolve({nohead:!0}).succeed(function(r){return e.url=r,n.requestDefaults&&N(e,n.requestDefaults),t=local.subscribe(e),t.response_}).then(function(){return t})},k.prototype.follow=function(e){"string"==typeof e&&local.isNavSchemeUri(e)&&(e=local.parseNavUri(e)),Array.isArray(e)||(e=[e]);var t=this;do t=new k(new P(e.shift()),t),this.requestDefaults&&t.setRequestDefaults(this.requestDefaults);while(e[0]);return t},k.prototype.unresolve=function(){return this.context.resetResolvedState(),this.links=null,this},k.prototype.rebase=function(e){return this.unresolve(),this.context.query=e,this.context.queryIsAbsolute=!0,this.context.url=e,this.context.urld=local.parseUri(e),this},k.prototype.resolve=function(e){var t=this;e=e||{};var n=e.nohead;delete e.nohead;var r=local.promise();if(null!==this.links&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1))r.fulfill(this.context.getUrl());else if(this.context.isBad()===!1||this.context.isBad()&&!e.noretry){if(this.context.resetResolvedState(),this.context.isRelative()&&!this.parentAgent){if("string"!=typeof this.context.query||!local.getServer(this.context.query))return t.context.setFailed({status:404,reason:"not found"}),r.reject(this.context.getError()),r;t.context=new P(t.context.query)}this.context.isRelative()?r=this.parentAgent.resolve(e).succeed(function(){var e=t.parentAgent.lookupLink(t.context);if(e)return t.context.setResolved(e),n?e:t.dispatch({method:"HEAD",url:e}).succeed(function(){return e});var r=new local.Response;throw r.writeHead(local.LINK_NOT_FOUND,"link query failed to match").end(),r}).fail(function(e){throw t.context.setFailed(e),e}):n?r.fulfill(t.context.getUrl()):r=this.dispatch({method:"HEAD",url:t.context.getUrl()}).succeed(function(){return t.context.getUrl()})}else r.reject(this.context.getError());return r},k.prototype.lookupLink=function(e){if(e.query)if("object"==typeof e.query){var t=local.queryLinks(this.links,e.query)[0];if(t)return local.UriTemplate.parse(t.href).expand(e.query)}else if("string"==typeof e.query)return local.isAbsUri(e.query)?e.query:local.joinRelPath(this.context.urld,e.query);return console.log("Failed to find a link to resolve context. Link query:",e.query,"Agent:",this),null},k.prototype.SUBSCRIBE=I("SUBSCRIBE"),k.prototype.HEAD=k.prototype.head=I("HEAD"),k.prototype.GET=k.prototype.get=I("GET"),k.prototype.DELETE=k.prototype.delete=I("DELETE"),k.prototype.POST=k.prototype.post=H("POST"),k.prototype.PUT=k.prototype.put=H("PUT"),k.prototype.PATCH=k.prototype.patch=H("PATCH"),k.prototype.NOTIFY=k.prototype.notify=H("NOTIFY"),local.agent=function(e){if(e instanceof k)return e;"string"==typeof e&&local.isNavSchemeUri(e)&&(e=local.parseNavUri(e)),Array.isArray(e)||(e=[e]);for(var t=new k(new P(e.shift()));e[0];)t=new k(new P(e.shift()),t);return t},local.addServer("hosts",function(e,t){var n=local.getServers();if("HEAD"!=e.method&&"GET"!=e.method)return t.writeHead(405,"bad method").end();if("GET"==e.method&&!local.preferredType(e,"application/json"))return t.writeHead(406,"bad accept - only provides application/json").end();var r=[],i=[],o=[];o.push({href:"/",rel:"self service via",id:"hosts",title:"Page Hosts"});for(var s in n)"hosts"!=s&&(i.push(s),r.push(local.dispatch({method:"HEAD",url:"httpl://"+s})));local.promise.bundle(r).then(function(n){return n.forEach(function(e,t){var n=local.queryLinks(e,{rel:"self"})[0];n||(n={rel:"service",id:i[t],href:"httpl://"+i[t]}),n.rel=n.rel?n.rel.replace(/(^|\b)(self|up|via)(\b|$)/gi,""):"service",o.push(n)}),t.setHeader("link",o),"HEAD"==e.method?t.writeHead(204,"ok, no content").end():(t.writeHead(200,"ok",{"content-type":"application/json"}),t.end({host_names:i}),void 0)})})}(),"undefined"!=typeof self&&"undefined"==typeof self.window&&("undefined"==typeof this.local.worker&&(this.local.worker={}),function(){function e(e,n){var r=local.worker.hostPage;try{r.channelSendMsg({op:"log",body:[e].concat(n)})}catch(i){r.channelSendMsg({op:"log",body:[e].concat(n.map(t))})}}function t(e){return Array.isArray(e)?e.map(t):e&&"object"==typeof e?JSON.stringify(e):e}function n(e,t){var n=255&e.charCodeAt(t);return n}function r(e){var t=!local.worker.hostPage,n=new local.worker.PageServer(local.worker.pages.length,e,t);t&&(local.worker.hostPage=n),local.worker.pages.push(n),local.addServer(n.id+".page",n),e.start&&e.start(),n.channelSendMsg({op:"ready",body:{hostPrivileges:t}}),local.worker.emit("connect",n)}if(function(){function e(e,t,n){local.BridgeServer.call(this),this.id=e,this.port=t,this.isHostPage=n,this.port.addEventListener("message",function(e){var t=e.data;if(!t)return console.error("Invalid message from page: Payload missing",e);switch(t.op){case"configure":this.onPageConfigure(t.body);break;case"terminate":this.terminate();break;default:this.onChannelMessage(t)}}.bind(this))}e.prototype=Object.create(local.BridgeServer.prototype),local.worker.PageServer=e,e.prototype.isChannelActive=function(){return!0},e.prototype.channelSendMsg=function(e){this.port.postMessage(e)},e.prototype.handleRemoteRequest=function(e,t){var n=local.worker.serverFn;n&&"function"==typeof n?n.call(this,e,t,this):n&&n.handleRemoteRequest?n.handleRemoteRequest(e,t,this):(t.writeHead(501,"not implemented"),t.end())},e.prototype.onPageConfigure=function(e){return this.isHostPage?(local.worker.config=e,void 0):(console.log('rejected "configure" from non-host connection'),void 0)}}(),local.util.mixinEventEmitter(local.worker),self.console={log:function(){var t=Array.prototype.slice.call(arguments);e("log",t)},dir:function(){var t=Array.prototype.slice.call(arguments);e("dir",t)},debug:function(){var t=Array.prototype.slice.call(arguments);e("debug",t)},warn:function(){var t=Array.prototype.slice.call(arguments);e("warn",t)},error:function(){var t=Array.prototype.slice.call(arguments);e("error",t)}},!self.btoa){var i="=",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";self.btoa=function(e){var t,r,s=i,a=o,l=[];e=""+e;var c=e.length-e.length%3;if(0===e.length)return e;for(t=0;c>t;t+=3)r=n(e,t)<<16|n(e,t+1)<<8|n(e,t+2),l.push(a.charAt(r>>18)),l.push(a.charAt(63&r>>12)),l.push(a.charAt(63&r>>6)),l.push(a.charAt(63&r));switch(e.length-c){case 1:r=n(e,t)<<16,l.push(a.charAt(r>>18)+a.charAt(63&r>>12)+s+s);break;case 2:r=n(e,t)<<16|n(e,t+1)<<8,l.push(a.charAt(r>>18)+a.charAt(63&r>>12)+a.charAt(63&r>>6)+s)}return l.join("")}}local.worker.setServer=function(e){local.worker.serverFn=e,local.addServer("self",e)},local.worker.pages=[],addEventListener("connect",function(e){r(e.ports[0])}),self.postMessage&&r(self)}()),"undefined"==typeof this.local&&(this.local={}),function(){function e(e){var t,n="";do t=e.replace("{n}",n),n=n?n+1:2;while(local.getServer(t));return t}function t(e,t){e.__localEventHandlers=[],t=t||{};var n;t.links!==!1&&(n={name:"click",handleEvent:r,container:e},e.addEventListener("click",n,!1),e.__localEventHandlers.push(n)),t.forms!==!1&&(n={name:"click",handleEvent:i,container:e},e.addEventListener("click",n,!0),e.__localEventHandlers.push(n),n={name:"submit",handleEvent:o,container:e},e.addEventListener("submit",n,!1),e.__localEventHandlers.push(n))}function n(e){e.__localEventHandlers&&(e.__localEventHandlers.forEach(function(t){e.removeEventListener(t.name,t)}),delete e.__localEventHandlers)}function r(e){if(0===e.button){var t=local.util.extractRequest.fromAnchor(e.orgtarget||e.target);if(!t||-1===["_top","_blank"].indexOf(t.target))return t?(e.preventDefault(),e.stopPropagation(),local.util.dispatchRequestEvent(e.target,t),!1):void 0}}function i(e){0===e.button&&local.util.trackFormSubmitter(e.target)}function o(e){var t=local.util.extractRequest(e.target,this.container);if(!t||-1===["_top","_blank"].indexOf(t.target))return t?(e.preventDefault(),e.stopPropagation(),local.util.finishPayloadFileReads(t).then(function(){local.util.dispatchRequestEvent(e.target,t)}),!1):void 0}local.logAllExceptions=!1,local.spawnWorkerServer=function(t,n,r){"function"==typeof n&&(r=n,n=null),n||(n={}),n.src=t,n.serverFn=r;var i=new local.WorkerBridgeServer(n),o=n.domain;return o||(o=0===t.indexOf("data:")?e("worker{n}"):e(t.split("/").pop().toLowerCase()+"{n}")),local.addServer(o,i),i},local.joinRelay=function(e,t,n){return"function"==typeof t&&(n=t,t=null),t||(t={}),t.provider=e,t.serverFn=n,new local.Relay(t)},local.bindRequestEvents=t,local.unbindRequestEvents=n}();